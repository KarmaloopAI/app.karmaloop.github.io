(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[879],{16738:function(e,t,s){Promise.resolve().then(s.bind(s,28390))},28390:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return F}});var a=s(14623),n=s(2265),r=s(43860),l=s(60429),i=s(5095),c=s(91723),o=s(65302),d=s(45131),m=s(17689),x=s(99397),u=s(73247),h=s(13041),p=s(60044),y=s(31047),j=s(48736),N=s(12194),f=s(2207),b=s(18930),g=s(95805),v=s(22252),w=s(5526),_=s(16524),C=s(22839),S=s(53417),D=s(32660),E=s(94630),Z=s(17684),k=s(89345),T=s(92735),A=s(89227),I=s(33276),O=s(69064);function P(e){var t,s;let{contactId:r,onBack:i}=e,[m,x]=(0,n.useState)(null),[u,p]=(0,n.useState)([]),[f,b]=(0,n.useState)(!0),[g,P]=(0,n.useState)("timeline"),[z,L]=(0,n.useState)(null),[F,U]=(0,n.useState)(!1),[G,Q]=(0,n.useState)(null),[M,R]=(0,n.useState)(!1);(0,n.useEffect)(()=>{J()},[r]);let J=async()=>{try{b(!0);let{data:e,error:t}=await w.OQ.from("contacts").select("*").eq("id",r).single();if(t)throw t;x(e);let{data:s,error:a}=await w.OQ.from("calls").select("\n          *,\n          agents (name),\n          call_transcripts (full_transcript, messages)\n        ").eq("contact_id",r).order("started_at",{ascending:!1});if(a)throw a;let n=s.map(e=>{var t,s;return{...e,agent_name:(null===(t=e.agents)||void 0===t?void 0:t.name)||"Unknown",transcript:(null===(s=e.call_transcripts)||void 0===s?void 0:s[0])||null}});p(n)}catch(e){console.error("Error fetching contact data:",e),O.ZP.error("Failed to load contact details")}finally{b(!1)}},q=async e=>{L(e),e.recording_url&&e.transcript||await V(e)},V=async e=>{if(e.vapi_call_id)try{R(!0);let t=await w.OQ.functions.invoke("call-data-retrieval",{body:{action:"getCall",callId:e.vapi_call_id,organizationId:null==m?void 0:m.organization_id}});if(t.error)throw Error(t.error.message||"Failed to fetch call data");let{call:s}=t.data;p(t=>t.map(t=>{var a,n,r,l;return t.id===e.id?{...t,outcome:"ended"===s.status?(null===(a=s.analysis)||void 0===a?void 0:a.successEvaluation)||"success":t.outcome,recording_url:(null===(n=s.recordings)||void 0===n?void 0:n.stereo)||(null===(r=s.recordings)||void 0===r?void 0:r.mono),transcript:{full_transcript:s.transcript,messages:s.messages||[]},summary:(null===(l=s.analysis)||void 0===l?void 0:l.summary)||t.summary}:t})),L(t=>{var a,n,r,l;return(null==t?void 0:t.id)===e.id?{...t,outcome:"ended"===s.status?(null===(a=s.analysis)||void 0===a?void 0:a.successEvaluation)||"success":t.outcome,recording_url:(null===(n=s.recordings)||void 0===n?void 0:n.stereo)||(null===(r=s.recordings)||void 0===r?void 0:r.mono),transcript:{full_transcript:s.transcript,messages:s.messages||[]},summary:(null===(l=s.analysis)||void 0===l?void 0:l.summary)||t.summary}:t})}catch(e){console.error("Error enriching call data:",e),O.ZP.error("Failed to load complete call data")}finally{R(!1)}},B=e=>{if(G&&(G.pause(),Q(null),U(!1)),!F){let t=new Audio(e);t.play(),Q(t),U(!0),t.onended=()=>{U(!1),Q(null)},t.onerror=()=>{O.ZP.error("Failed to play recording"),U(!1),Q(null)}}},X=(e,t)=>{let s=document.createElement("a");s.href=e,s.download="call-".concat(t,"-recording.mp3"),s.target="_blank",document.body.appendChild(s),s.click(),document.body.removeChild(s)},H=e=>"".concat(Math.floor(e/60),":").concat((e%60).toString().padStart(2,"0")),W=(e,t)=>{let s="w-4 h-4";return"inbound"===e?(0,a.jsx)(_.Z,{className:s}):(0,a.jsx)(C.Z,{className:s})},K=e=>{switch(e){case"success":return(0,a.jsx)(o.Z,{className:"w-4 h-4 text-success-500"});case"failure":return(0,a.jsx)(d.Z,{className:"w-4 h-4 text-error-500"});case"no_answer":return(0,a.jsx)(v.Z,{className:"w-4 h-4 text-warning-500"});case"in_progress":return(0,a.jsx)(c.Z,{className:"w-4 h-4 text-primary-500"});case"voicemail":return(0,a.jsx)(S.Z,{className:"w-4 h-4 text-info-500"});case"busy":return(0,a.jsx)(v.Z,{className:"w-4 h-4 text-warning-600"});default:return(0,a.jsx)(v.Z,{className:"w-4 h-4 text-neutral-500"})}};return f?(0,a.jsx)("div",{className:"flex items-center justify-center h-64",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"})}):m?(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,a.jsx)("button",{onClick:i,className:"p-2 hover:bg-bg-secondary rounded-lg transition-colors",children:(0,a.jsx)(D.Z,{className:"w-5 h-5 text-text-secondary"})}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("h1",{className:"text-2xl font-bold text-text-primary",children:[m.first_name," ",m.last_name]}),(0,a.jsx)("p",{className:"text-text-secondary",children:m.company})]})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsxs)("button",{className:"btn-secondary",children:[(0,a.jsx)(E.Z,{className:"w-4 h-4 mr-2"}),"Edit"]}),(0,a.jsx)("button",{className:"p-2 hover:bg-bg-secondary rounded-lg",children:(0,a.jsx)(Z.Z,{className:"w-5 h-5 text-text-secondary"})})]})]}),(0,a.jsxs)("div",{className:"grid md:grid-cols-4 gap-4",children:[(0,a.jsx)("div",{className:"card p-4",children:(0,a.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,a.jsx)(h.Z,{className:"w-5 h-5 text-primary-600"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm text-text-secondary",children:"Phone"}),(0,a.jsx)("p",{className:"font-medium text-text-primary",children:(0,w.un)(m.phone_number)})]})]})}),(0,a.jsx)("div",{className:"card p-4",children:(0,a.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,a.jsx)(k.Z,{className:"w-5 h-5 text-primary-600"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm text-text-secondary",children:"Email"}),(0,a.jsx)("p",{className:"font-medium text-text-primary",children:m.email||"Not provided"})]})]})}),(0,a.jsx)("div",{className:"card p-4",children:(0,a.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,a.jsx)(N.Z,{className:"w-5 h-5 text-primary-600"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm text-text-secondary",children:"Total Calls"}),(0,a.jsx)("p",{className:"font-medium text-text-primary",children:m.total_calls||0})]})]})}),(0,a.jsx)("div",{className:"card p-4",children:(0,a.jsxs)("div",{className:"flex items-center space-x-3",children:[K(m.last_call_outcome||"unknown"),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm text-text-secondary",children:"Last Outcome"}),(0,a.jsx)("p",{className:"font-medium text-text-primary capitalize",children:(null===(t=m.last_call_outcome)||void 0===t?void 0:t.replace("_"," "))||"None"})]})]})})]}),(0,a.jsx)("div",{className:"border-b border-border-subtle",children:(0,a.jsx)("nav",{className:"flex space-x-8",children:[{id:"timeline",label:"Timeline",icon:y.Z},{id:"calls",label:"Call History",icon:N.Z},{id:"details",label:"Details",icon:j.Z}].map(e=>{let t=e.icon;return(0,a.jsxs)("button",{onClick:()=>P(e.id),className:"flex items-center space-x-2 py-4 px-1 border-b-2 transition-colors ".concat(g===e.id?"border-primary-600 text-primary-600":"border-transparent text-text-secondary hover:text-text-primary"),children:[(0,a.jsx)(t,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:e.label})]},e.id)})})}),(0,a.jsxs)("div",{className:"min-h-[400px]",children:["timeline"===g&&(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-text-primary",children:"Communication Timeline"}),u.length>0?(0,a.jsx)("div",{className:"space-y-4",children:u.map((e,t)=>(0,a.jsx)(l.E.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.1*t},className:"card p-4 cursor-pointer hover:bg-bg-secondary transition-colors",onClick:()=>q(e),children:(0,a.jsxs)("div",{className:"flex items-start space-x-4",children:[(0,a.jsx)("div",{className:"p-2 rounded-lg ".concat("inbound"===e.direction?"bg-blue-100":"bg-green-100"),children:W(e.direction,e.outcome)}),(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,a.jsx)("h4",{className:"font-medium text-text-primary",children:"inbound"===e.direction?"Inbound Call":"Outbound Call"}),(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[K(e.outcome||"unknown"),(0,a.jsx)("span",{className:"text-sm text-text-secondary",children:new Date(e.started_at).toLocaleString()})]})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-4 text-sm text-text-secondary",children:[(0,a.jsxs)("span",{className:"flex items-center space-x-1",children:[(0,a.jsx)(c.Z,{className:"w-3 h-3"}),(0,a.jsx)("span",{children:H(e.duration_seconds)})]}),(0,a.jsxs)("span",{children:["Agent: ",e.agent_name]}),e.cost_usd>0&&(0,a.jsxs)("span",{children:["$",e.cost_usd.toFixed(3)]})]}),e.summary&&(0,a.jsx)("p",{className:"mt-2 text-sm text-text-secondary line-clamp-2",children:e.summary})]})]})},e.id))}):(0,a.jsxs)("div",{className:"text-center py-12",children:[(0,a.jsx)(N.Z,{className:"w-12 h-12 text-text-tertiary mx-auto mb-3"}),(0,a.jsx)("p",{className:"text-text-secondary",children:"No calls yet"}),(0,a.jsx)("p",{className:"text-sm text-text-tertiary",children:"Call history will appear here"})]})]}),"calls"===g&&(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-text-primary",children:"Call History"}),(0,a.jsxs)("button",{onClick:()=>{O.ZP.promise(w.OQ.functions.invoke("call-data-retrieval",{body:{action:"syncMissingCalls",organizationId:m.organization_id}}).then(e=>{if(e.error)throw Error(e.error.message);return e.data}),{loading:"Syncing call data...",success:"Call data synced successfully",error:"Failed to sync call data"}).then(()=>J())},className:"btn-secondary text-sm",children:[(0,a.jsx)(T.Z,{className:"w-4 h-4 mr-2"}),"Sync Latest"]})]}),(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"w-full",children:[(0,a.jsx)("thead",{children:(0,a.jsxs)("tr",{className:"border-b border-border-subtle",children:[(0,a.jsx)("th",{className:"text-left py-3 px-4 text-sm font-medium text-text-secondary",children:"Date"}),(0,a.jsx)("th",{className:"text-left py-3 px-4 text-sm font-medium text-text-secondary",children:"Direction"}),(0,a.jsx)("th",{className:"text-left py-3 px-4 text-sm font-medium text-text-secondary",children:"Duration"}),(0,a.jsx)("th",{className:"text-left py-3 px-4 text-sm font-medium text-text-secondary",children:"Outcome"}),(0,a.jsx)("th",{className:"text-left py-3 px-4 text-sm font-medium text-text-secondary",children:"Agent"}),(0,a.jsx)("th",{className:"text-left py-3 px-4 text-sm font-medium text-text-secondary",children:"Actions"})]})}),(0,a.jsx)("tbody",{children:u.map(e=>(0,a.jsxs)("tr",{className:"border-b border-border-subtle hover:bg-bg-secondary",children:[(0,a.jsxs)("td",{className:"py-3 px-4 text-sm text-text-primary",children:[new Date(e.started_at).toLocaleDateString(),(0,a.jsx)("br",{}),(0,a.jsx)("span",{className:"text-xs text-text-tertiary",children:new Date(e.started_at).toLocaleTimeString()})]}),(0,a.jsx)("td",{className:"py-3 px-4",children:(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[W(e.direction,e.outcome),(0,a.jsx)("span",{className:"text-sm text-text-primary capitalize",children:e.direction})]})}),(0,a.jsx)("td",{className:"py-3 px-4 text-sm text-text-primary",children:H(e.duration_seconds)}),(0,a.jsx)("td",{className:"py-3 px-4",children:(0,a.jsx)("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ".concat((0,w.lj)(e.outcome)),children:e.outcome.replace("_"," ")})}),(0,a.jsx)("td",{className:"py-3 px-4 text-sm text-text-primary",children:e.agent_name}),(0,a.jsx)("td",{className:"py-3 px-4",children:(0,a.jsx)("div",{className:"flex items-center space-x-2",children:(0,a.jsx)("button",{onClick:()=>q(e),className:"text-primary-600 hover:text-primary-700 text-sm",children:"View Details"})})})]},e.id))})]})})]}),"details"===g&&(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-text-primary",children:"Contact Details"}),(0,a.jsxs)("div",{className:"grid md:grid-cols-2 gap-6",children:[(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"First Name"}),(0,a.jsx)("input",{type:"text",value:m.first_name,className:"input",readOnly:!0})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Last Name"}),(0,a.jsx)("input",{type:"text",value:m.last_name,className:"input",readOnly:!0})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Company"}),(0,a.jsx)("input",{type:"text",value:m.company||"",className:"input",readOnly:!0})]})]}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Phone Number"}),(0,a.jsx)("input",{type:"text",value:m.phone_number,className:"input",readOnly:!0})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Email"}),(0,a.jsx)("input",{type:"email",value:m.email||"",className:"input",readOnly:!0})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Created"}),(0,a.jsx)("input",{type:"text",value:new Date(m.created_at).toLocaleDateString(),className:"input",readOnly:!0})]})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Notes"}),(0,a.jsx)("textarea",{value:m.notes||"",className:"input min-h-[100px]",readOnly:!0,placeholder:"No notes available"})]})]})]}),z&&(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:(0,a.jsx)("div",{className:"bg-bg-primary rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:(0,a.jsxs)("div",{className:"p-6",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,a.jsx)("h3",{className:"text-xl font-bold text-text-primary",children:"Call Details"}),(0,a.jsx)("button",{onClick:()=>L(null),className:"p-2 hover:bg-bg-secondary rounded-lg",children:(0,a.jsx)(D.Z,{className:"w-5 h-5"})})]}),M&&(0,a.jsxs)("div",{className:"text-center py-4",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary-600 mx-auto"}),(0,a.jsx)("p",{className:"text-sm text-text-secondary mt-2",children:"Loading complete call data..."})]}),(0,a.jsxs)("div",{className:"grid md:grid-cols-2 gap-6 mb-6",children:[(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("span",{className:"text-sm text-text-secondary",children:"Direction:"}),(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[W(z.direction,z.outcome),(0,a.jsx)("span",{className:"capitalize text-text-primary",children:z.direction})]})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("span",{className:"text-sm text-text-secondary",children:"Duration:"}),(0,a.jsx)("span",{className:"text-text-primary",children:H(z.duration_seconds)})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("span",{className:"text-sm text-text-secondary",children:"Outcome:"}),(0,a.jsx)("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ".concat((0,w.lj)(z.outcome)),children:z.outcome.replace("_"," ")})]})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("span",{className:"text-sm text-text-secondary",children:"Agent:"}),(0,a.jsx)("span",{className:"text-text-primary",children:z.agent_name})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("span",{className:"text-sm text-text-secondary",children:"Cost:"}),(0,a.jsxs)("span",{className:"text-text-primary",children:["$",z.cost_usd.toFixed(3)]})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("span",{className:"text-sm text-text-secondary",children:"Date:"}),(0,a.jsx)("span",{className:"text-text-primary",children:new Date(z.started_at).toLocaleString()})]})]})]}),z.recording_url&&(0,a.jsxs)("div",{className:"mb-6 p-4 bg-bg-secondary rounded-lg",children:[(0,a.jsx)("h4",{className:"font-medium text-text-primary mb-3",children:"Call Recording"}),(0,a.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,a.jsxs)("button",{onClick:()=>B(z.recording_url),className:"flex items-center space-x-2 px-3 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700",children:[F?(0,a.jsx)(A.Z,{className:"w-4 h-4"}):(0,a.jsx)(I.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:F?"Pause":"Play"})]}),(0,a.jsxs)("button",{onClick:()=>X(z.recording_url,z.id),className:"flex items-center space-x-2 px-3 py-2 border border-border-subtle rounded-lg hover:bg-bg-tertiary",children:[(0,a.jsx)(T.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{children:"Download"})]})]})]}),z.summary&&(0,a.jsxs)("div",{className:"mb-6",children:[(0,a.jsx)("h4",{className:"font-medium text-text-primary mb-2",children:"Call Summary"}),(0,a.jsx)("p",{className:"text-text-secondary bg-bg-secondary p-3 rounded-lg",children:z.summary})]}),(null===(s=z.transcript)||void 0===s?void 0:s.full_transcript)&&(0,a.jsxs)("div",{children:[(0,a.jsx)("h4",{className:"font-medium text-text-primary mb-3",children:"Full Transcript"}),(0,a.jsx)("div",{className:"bg-white border border-bg-tertiary rounded-lg p-4 max-h-64 overflow-y-auto",children:z.transcript.messages&&z.transcript.messages.length>0?(0,a.jsx)("div",{className:"space-y-3",children:z.transcript.messages.map((e,t)=>{let s=String(e.role||"").toLowerCase(),n=["assistant","agent","bot","system"].includes(s);return(0,a.jsxs)("div",{className:"p-3 rounded-lg ".concat(n?"bg-blue-50 border border-blue-200":"bg-gray-50 border border-gray-200"),children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,a.jsxs)("span",{className:"font-medium text-sm text-gray-800",children:[n?"Agent":"Customer"," (",s,")"]}),(0,a.jsxs)("span",{className:"text-xs text-gray-500",children:[Math.floor(e.time/1e3),"s"]})]}),(0,a.jsx)("p",{className:"text-sm text-gray-900",children:e.message})]},t)})}):(0,a.jsx)("pre",{className:"text-sm text-gray-700 whitespace-pre-wrap font-mono leading-relaxed",children:z.transcript.full_transcript})})]})]})})})]}):(0,a.jsxs)("div",{className:"text-center py-12",children:[(0,a.jsx)("p",{className:"text-text-secondary",children:"Contact not found"}),(0,a.jsx)("button",{onClick:i,className:"btn-secondary mt-4",children:"Go Back"})]})}function z(e){let{onNavigate:t}=e,{state:s,actions:_,dispatch:C}=(0,r.q)(),{profile:S,contacts:D,agents:E}=s,[Z,k]=(0,n.useState)(!1),[T,A]=(0,n.useState)(""),[I,z]=(0,n.useState)("all"),[L,F]=(0,n.useState)(!1),[U,G]=(0,n.useState)(!1),[Q,M]=(0,n.useState)(!1),[R,J]=(0,n.useState)([]),[q,V]=(0,n.useState)(""),[B,X]=(0,n.useState)(!1),[H,W]=(0,n.useState)(null),[K,Y]=(0,n.useState)(null),[$,ee]=(0,n.useState)({firstName:"",lastName:"",phoneNumber:"",email:"",company:""});(0,n.useEffect)(()=>{et(),_.fetchAgents()},[S]);let et=async()=>{if(null==S?void 0:S.organization_id)try{k(!0);let{data:e}=await w.OQ.from("contacts").select("*").eq("organization_id",S.organization_id).order("created_at",{ascending:!1});C({type:"SET_CONTACTS",contacts:e||[]})}catch(e){console.error("Error fetching contacts:",e),O.ZP.error("Failed to load contacts")}finally{k(!1)}},es=async()=>{console.log("\uD83D\uDCE5 handleImportContacts called",{csvFile:!!H,importData:q.length});let e="";if(H)console.log("\uD83D\uDCC4 Processing CSV file:",H.name),e=await H.text();else if(q.trim())console.log("\uD83D\uDCDD Processing text input, length:",q.length),e=q;else{O.ZP.error("Please enter contact data or upload a CSV file");return}try{X(!0),console.log("\uD83D\uDCE4 Calling import-contacts API...");let t=await (0,w.k_)("import-contacts",{method:"POST",body:JSON.stringify({contacts:e,defaultCountryCode:"+1",format:"auto"})});console.log("✅ Import result:",t),O.ZP.success("Successfully imported ".concat(t.summary.imported," contacts")),t.summary.duplicates>0&&(0,O.ZP)("".concat(t.summary.duplicates," duplicates skipped"),{icon:"⚠️"}),t.summary.invalid>0&&O.ZP.error("".concat(t.summary.invalid," invalid entries")),F(!1),V(""),W(null),await et()}catch(e){console.error("Error importing contacts:",e),O.ZP.error(e.message||"Failed to import contacts")}finally{X(!1)}},ea=async()=>{if(console.log("\uD83D\uDC65 handleAddContact called",$),!$.phoneNumber.trim()){O.ZP.error("Phone number is required");return}try{console.log("\uD83D\uDCBE Inserting contact into database...");let{error:e}=await w.OQ.from("contacts").insert({organization_id:null==S?void 0:S.organization_id,first_name:$.firstName||null,last_name:$.lastName||null,phone_number:$.phoneNumber,email:$.email||null,company:$.company||null});if(e)throw console.error("❌ Database error:",e),e;console.log("✅ Contact added successfully"),O.ZP.success("Contact added successfully"),G(!1),ee({firstName:"",lastName:"",phoneNumber:"",email:"",company:""}),await et()}catch(e){console.error("Error adding contact:",e),O.ZP.error(e.message||"Failed to add contact")}},en=async(e,t)=>{if(!t){J([e.id]),M(!0);return}try{let s=E.find(e=>e.id===t);if(!s){O.ZP.error("Selected agent not found");return}if(!s.vapi_assistant_id){O.ZP.error("Agent is not properly configured");return}let a=await (0,w.k_)("initiate-outbound-call",{method:"POST",body:JSON.stringify({assistantId:s.vapi_assistant_id,customerNumber:e.phone_number,contactId:e.id})});a.success?(O.ZP.success("Calling ".concat(e.first_name||e.phone_number,"...")),await et()):O.ZP.error(a.error||"Failed to initiate call")}catch(e){console.error("Error initiating outbound call:",e),O.ZP.error(e.message||"Failed to initiate call")}},er=async e=>{if(0===R.length){O.ZP.error("No contacts selected");return}try{if(!E.find(t=>t.id===e)){O.ZP.error("Selected agent not found");return}let t=R.map(t=>{let s=D.find(e=>e.id===t);if(s)return en(s,e)});await Promise.all(t),J([]),M(!1),O.ZP.success("Initiated calls for ".concat(R.length," contacts"))}catch(e){console.error("Error with bulk calling:",e),O.ZP.error("Failed to initiate some calls")}},el=D.filter(e=>{var t,s,a,n;let r=(null===(t=e.first_name)||void 0===t?void 0:t.toLowerCase().includes(T.toLowerCase()))||(null===(s=e.last_name)||void 0===s?void 0:s.toLowerCase().includes(T.toLowerCase()))||e.phone_number.includes(T)||(null===(a=e.email)||void 0===a?void 0:a.toLowerCase().includes(T.toLowerCase()))||(null===(n=e.company)||void 0===n?void 0:n.toLowerCase().includes(T.toLowerCase())),l="all"===I||"contacted"===I&&e.total_calls>0||"never_contacted"===I&&0===e.total_calls||"success"===I&&"success"===e.last_call_outcome||"pending"===I&&"in_progress"===e.last_call_outcome;return r&&l}),ei=e=>{if(0===e.total_calls)return(0,a.jsx)(c.Z,{className:"w-4 h-4 text-neutral-400"});switch(e.last_call_outcome){case"success":return(0,a.jsx)(o.Z,{className:"w-4 h-4 text-success-500"});case"failure":return(0,a.jsx)(d.Z,{className:"w-4 h-4 text-error-500"});case"in_progress":return(0,a.jsx)(c.Z,{className:"w-4 h-4 text-warning-500"});default:return(0,a.jsx)(c.Z,{className:"w-4 h-4 text-neutral-400"})}},ec=e=>{var t;if(0===e.total_calls)return"Never contacted";let s=e.last_outbound_call||e.last_inbound_call,a=s?new Date(s).toLocaleDateString():"Unknown";return"".concat((null===(t=e.last_call_outcome)||void 0===t?void 0:t.replace("_"," "))||"Unknown"," - ").concat(a)};return(0,a.jsx)("div",{className:"space-y-6",children:K?(0,a.jsx)(P,{contactId:K,onBack:()=>Y(null)}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{className:"text-3xl font-bold text-text-primary",children:"CRM"}),(0,a.jsx)("p",{className:"text-text-secondary mt-1",children:"Manage your contacts and track communication history"})]}),(0,a.jsxs)("div",{className:"flex space-x-3",children:[(0,a.jsxs)("button",{onClick:()=>F(!0),className:"btn-secondary flex items-center",children:[(0,a.jsx)(m.Z,{className:"w-4 h-4 mr-2"}),"Import Contacts"]}),(0,a.jsxs)("button",{onClick:()=>G(!0),className:"btn-primary flex items-center",children:[(0,a.jsx)(x.Z,{className:"w-4 h-4 mr-2"}),"Add Contact"]})]})]}),(0,a.jsx)("div",{className:"card",children:(0,a.jsxs)("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0",children:[(0,a.jsx)("div",{className:"flex-1 max-w-md",children:(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(u.Z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-neutral-400"}),(0,a.jsx)("input",{type:"text",placeholder:"Search contacts...",value:T,onChange:e=>A(e.target.value),className:"input-field pl-10"})]})}),(0,a.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,a.jsxs)("select",{value:I,onChange:e=>z(e.target.value),className:"input-field",children:[(0,a.jsx)("option",{value:"all",children:"All Contacts"}),(0,a.jsx)("option",{value:"contacted",children:"Contacted"}),(0,a.jsx)("option",{value:"never_contacted",children:"Never Contacted"}),(0,a.jsx)("option",{value:"success",children:"Successful Calls"}),(0,a.jsx)("option",{value:"pending",children:"Pending Follow-up"})]}),(0,a.jsxs)("span",{className:"text-sm text-neutral-500",children:[el.length," of ",D.length," contacts"]})]})]})}),(0,a.jsx)("div",{className:"card p-0 overflow-hidden",children:Z?(0,a.jsxs)("div",{className:"p-8 text-center",children:[(0,a.jsx)("div",{className:"animate-spin w-8 h-8 border-4 border-primary-200 border-t-primary-600 rounded-full mx-auto"}),(0,a.jsx)("p",{className:"text-neutral-500 mt-2",children:"Loading contacts..."})]}):el.length>0?(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"w-full",children:[(0,a.jsx)("thead",{className:"bg-bg-secondary border-b border-border-subtle",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"text-left py-4 px-6 font-medium text-text-primary",children:"Contact"}),(0,a.jsx)("th",{className:"text-left py-4 px-6 font-medium text-text-primary",children:"Phone"}),(0,a.jsx)("th",{className:"text-left py-4 px-6 font-medium text-text-primary",children:"Company"}),(0,a.jsx)("th",{className:"text-left py-4 px-6 font-medium text-text-primary",children:"Last Contact"}),(0,a.jsx)("th",{className:"text-left py-4 px-6 font-medium text-text-primary",children:"Status"}),(0,a.jsx)("th",{className:"text-left py-4 px-6 font-medium text-text-primary",children:"Actions"})]})}),(0,a.jsx)("tbody",{className:"divide-y divide-border-subtle",children:el.map((e,t)=>{var s,n;return(0,a.jsxs)(l.E.tr,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.05*t},className:"hover:bg-bg-secondary transition-colors",children:[(0,a.jsx)("td",{className:"py-4 px-6",children:(0,a.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,a.jsx)("div",{className:"icon-box w-10 h-10",children:(0,a.jsx)("span",{className:"text-sm font-medium text-white",children:(null===(s=e.first_name)||void 0===s?void 0:s[0])||(null===(n=e.last_name)||void 0===n?void 0:n[0])||e.phone_number[0]})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-medium text-text-primary",children:e.first_name||e.last_name?"".concat(e.first_name||""," ").concat(e.last_name||"").trim():"Unknown"}),e.email&&(0,a.jsx)("p",{className:"text-sm text-text-secondary",children:e.email})]})]})}),(0,a.jsx)("td",{className:"py-4 px-6",children:(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)(h.Z,{className:"w-4 h-4 text-text-secondary"}),(0,a.jsx)("span",{className:"text-text-primary",children:(0,w.un)(e.phone_number)})]})}),(0,a.jsx)("td",{className:"py-4 px-6",children:e.company?(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)(p.Z,{className:"w-4 h-4 text-text-secondary"}),(0,a.jsx)("span",{className:"text-text-primary",children:e.company})]}):(0,a.jsx)("span",{className:"text-text-secondary",children:"—"})}),(0,a.jsx)("td",{className:"py-4 px-6",children:(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)(y.Z,{className:"w-4 h-4 text-text-secondary"}),(0,a.jsx)("span",{className:"text-sm text-text-secondary",children:e.last_outbound_call||e.last_inbound_call?new Date(e.last_outbound_call||e.last_inbound_call).toLocaleDateString():"Never"})]})}),(0,a.jsx)("td",{className:"py-4 px-6",children:(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[ei(e),(0,a.jsx)("span",{className:"text-sm text-neutral-600",children:ec(e)})]})}),(0,a.jsx)("td",{className:"py-4 px-6",children:(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)("button",{onClick:()=>Y(e.id),className:"p-2 text-neutral-400 hover:text-primary-600 hover:bg-primary-50 rounded-lg transition-colors",title:"View Details",children:(0,a.jsx)(j.Z,{className:"w-4 h-4"})}),(0,a.jsx)("button",{onClick:()=>en(e),className:"p-2 text-neutral-400 hover:text-primary-600 hover:bg-primary-50 rounded-lg transition-colors",title:"Call Contact",disabled:0===E.filter(e=>e.is_active&&e.phone_number).length,children:(0,a.jsx)(N.Z,{className:"w-4 h-4"})}),(0,a.jsx)("button",{className:"p-2 text-neutral-400 hover:text-primary-600 hover:bg-primary-50 rounded-lg transition-colors",title:"Edit Contact",children:(0,a.jsx)(f.Z,{className:"w-4 h-4"})}),(0,a.jsx)("button",{className:"p-2 text-neutral-400 hover:text-error-600 hover:bg-error-50 rounded-lg transition-colors",title:"Delete Contact",children:(0,a.jsx)(b.Z,{className:"w-4 h-4"})})]})})]},e.id)})})]})}):(0,a.jsxs)("div",{className:"p-12 text-center",children:[(0,a.jsx)(g.Z,{className:"w-16 h-16 text-neutral-300 mx-auto mb-4"}),(0,a.jsx)("h3",{className:"text-lg font-medium text-neutral-900 mb-2",children:T||"all"!==I?"No contacts found":"No contacts yet"}),(0,a.jsx)("p",{className:"text-neutral-600 mb-6",children:T||"all"!==I?"Try adjusting your search or filter criteria":"Import contacts or add them manually to get started"}),!T&&"all"===I&&(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-3",children:[(0,a.jsxs)("button",{onClick:()=>F(!0),className:"btn-secondary flex items-center justify-center",children:[(0,a.jsx)(m.Z,{className:"w-4 h-4 mr-2"}),"Import Contacts"]}),(0,a.jsxs)("button",{onClick:()=>G(!0),className:"btn-primary flex items-center justify-center",children:[(0,a.jsx)(x.Z,{className:"w-4 h-4 mr-2"}),"Add Manually"]})]})]})}),(0,a.jsx)(i.M,{children:L&&(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:(0,a.jsxs)(l.E.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},className:"card rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-lg shadow-primary-500/20",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-6",children:[(0,a.jsx)("h2",{className:"text-xl font-bold text-text-primary",children:"Import Contacts"}),(0,a.jsx)("button",{onClick:()=>F(!1),className:"p-2 hover:bg-neutral-100 rounded-lg transition-colors",children:"✕"})]}),(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"bg-primary-50 border border-primary-200 rounded-xl p-4",children:[(0,a.jsx)("h3",{className:"font-medium text-primary-900 mb-2",children:"Supported Formats"}),(0,a.jsxs)("div",{className:"text-sm text-primary-700 space-y-1",children:[(0,a.jsxs)("p",{children:["• ",(0,a.jsx)("strong",{children:"Phone only:"})," One phone number per line"]}),(0,a.jsxs)("p",{children:["• ",(0,a.jsx)("strong",{children:"Name + Phone:"})," John Doe +1234567890"]}),(0,a.jsxs)("p",{children:["• ",(0,a.jsx)("strong",{children:"Comma separated:"})," John Doe, +1234567890, john@email.com, Company"]})]})]}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-neutral-700 mb-2",children:"Upload CSV File"}),(0,a.jsxs)("div",{className:"border-2 border-dashed border-neutral-300 rounded-xl p-6 text-center hover:border-primary-400 transition-colors",children:[(0,a.jsx)("input",{type:"file",accept:".csv,text/csv",onChange:e=>{var t;let s=null===(t=e.target.files)||void 0===t?void 0:t[0];s&&("text/csv"===s.type||s.name.endsWith(".csv")?(W(s),V("")):O.ZP.error("Please select a CSV file"))},className:"hidden",id:"csv-upload"}),(0,a.jsxs)("label",{htmlFor:"csv-upload",className:"cursor-pointer",children:[(0,a.jsx)(m.Z,{className:"w-8 h-8 text-neutral-400 mx-auto mb-2"}),(0,a.jsx)("p",{className:"text-sm text-neutral-600",children:H?H.name:"Click to upload CSV file"}),(0,a.jsx)("p",{className:"text-xs text-neutral-500 mt-1",children:"Support for CSV files with headers: Name, Phone, Email, Company"})]})]})]}),(0,a.jsx)("div",{className:"flex items-center justify-center",children:(0,a.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,a.jsx)("div",{className:"h-px bg-neutral-300 flex-1 w-16"}),(0,a.jsx)("span",{className:"text-sm text-neutral-500",children:"OR"}),(0,a.jsx)("div",{className:"h-px bg-neutral-300 flex-1 w-16"})]})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-neutral-700 mb-2",children:"Paste contact data"}),(0,a.jsx)("textarea",{value:q,onChange:e=>{V(e.target.value),e.target.value.trim()&&W(null)},placeholder:"John Smith +1234567890\nJane Doe, +1987654321, jane@company.com, Acme Corp\n+1555123456\nMichael Johnson +1444555666",className:"input-field resize-none h-32",disabled:!!H}),(0,a.jsx)("p",{className:"text-xs text-neutral-500 mt-1",children:"Each contact should be on a separate line. Phone numbers will be automatically formatted."})]})]}),(0,a.jsxs)("div",{className:"flex justify-end space-x-3",children:[(0,a.jsx)("button",{type:"button",onClick:()=>{console.log("\uD83D\uDEAB Import cancel clicked"),F(!1)},className:"btn-secondary",children:"Cancel"}),(0,a.jsx)("button",{type:"button",onClick:e=>{e.preventDefault(),console.log("\uD83D\uDE80 Import button clicked",{disabled:B||!q.trim()&&!H,importing:B,hasData:!!q.trim(),hasFile:!!H}),es()},disabled:B||!q.trim()&&!H,className:"btn-primary",children:B?"Importing...":"Import Contacts"})]})]})]})})}),(0,a.jsx)(i.M,{children:U&&(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:(0,a.jsxs)(l.E.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},className:"card rounded-2xl p-6 w-full max-w-md shadow-2xl shadow-primary-500/20",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-6",children:[(0,a.jsx)("h2",{className:"text-xl font-bold text-text-primary",children:"Add Contact"}),(0,a.jsx)("button",{onClick:()=>G(!1),className:"p-2 hover:bg-bg-secondary rounded-lg transition-colors",children:"✕"})]}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-text-primary mb-1",children:"First Name"}),(0,a.jsx)("input",{type:"text",value:$.firstName,onChange:e=>ee(t=>({...t,firstName:e.target.value})),className:"input-field",placeholder:"John"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-text-primary mb-1",children:"Last Name"}),(0,a.jsx)("input",{type:"text",value:$.lastName,onChange:e=>ee(t=>({...t,lastName:e.target.value})),className:"input-field",placeholder:"Doe"})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-text-primary mb-1",children:"Phone Number *"}),(0,a.jsx)("input",{type:"tel",value:$.phoneNumber,onChange:e=>ee(t=>({...t,phoneNumber:e.target.value})),className:"input-field",placeholder:"+1 (555) 123-4567",required:!0})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-text-primary mb-1",children:"Email"}),(0,a.jsx)("input",{type:"email",value:$.email,onChange:e=>ee(t=>({...t,email:e.target.value})),className:"input-field",placeholder:"john@company.com"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-text-primary mb-1",children:"Company"}),(0,a.jsx)("input",{type:"text",value:$.company,onChange:e=>ee(t=>({...t,company:e.target.value})),className:"input-field",placeholder:"Acme Corp"})]}),(0,a.jsxs)("div",{className:"flex justify-end space-x-3 pt-4",children:[(0,a.jsx)("button",{type:"button",onClick:()=>{console.log("\uD83D\uDEAB Cancel button clicked"),G(!1)},className:"btn-secondary",children:"Cancel"}),(0,a.jsx)("button",{type:"button",onClick:e=>{e.preventDefault(),console.log("\uD83D\uDE80 Add contact button clicked",{disabled:!$.phoneNumber.trim()}),ea()},disabled:!$.phoneNumber.trim(),className:"btn-primary",children:"Add Contact"})]})]})]})})}),(0,a.jsx)(i.M,{children:Q&&(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:(0,a.jsxs)(l.E.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},className:"card rounded-2xl p-6 w-full max-w-md",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-6",children:[(0,a.jsx)("h2",{className:"text-xl font-bold text-text-primary",children:"Select Agent"}),(0,a.jsx)("button",{onClick:()=>M(!1),className:"p-2 hover:bg-neutral-100 rounded-lg transition-colors",children:"✕"})]}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("p",{className:"text-sm text-neutral-600",children:["Choose which agent will handle the outbound call",R.length>1?"s":""," to:"]}),(0,a.jsx)("div",{className:"bg-neutral-50 rounded-lg p-3",children:(0,a.jsx)("div",{className:"text-sm font-medium text-neutral-900",children:1===R.length?(()=>{let e=D.find(e=>e.id===R[0]);return e?"".concat(e.first_name||""," ").concat(e.last_name||"").trim()||e.phone_number:"Unknown contact"})():"".concat(R.length," selected contacts")})}),(0,a.jsx)("div",{className:"space-y-2",children:E.filter(e=>e.is_active&&e.phone_number).map(e=>(0,a.jsx)("button",{onClick:()=>{if(1===R.length){let t=D.find(e=>e.id===R[0]);t&&en(t,e.id)}else er(e.id);M(!1)},className:"w-full text-left p-3 border border-neutral-200 rounded-lg hover:border-primary-300 hover:bg-primary-50 transition-colors",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"font-medium text-neutral-900",children:e.name}),(0,a.jsxs)("div",{className:"text-sm text-neutral-600",children:["Savannah"===e.voice_id?"Sandra (Savannah)":"Jackson (Elliot)"," • ",(0,w.un)(e.phone_number)]})]}),(0,a.jsx)(N.Z,{className:"w-5 h-5 text-primary-600"})]})},e.id))}),0===E.filter(e=>e.is_active&&e.phone_number).length&&(0,a.jsxs)("div",{className:"text-center py-6",children:[(0,a.jsx)(v.Z,{className:"w-12 h-12 text-warning-500 mx-auto mb-3"}),(0,a.jsx)("h3",{className:"font-medium text-neutral-900 mb-2",children:"No Active Agents"}),(0,a.jsx)("p",{className:"text-sm text-neutral-600 mb-4",children:"You need at least one active agent with a phone number to make outbound calls."}),(0,a.jsx)("button",{onClick:()=>t("/agents"),className:"btn-primary text-sm",children:"Manage Agents"})]}),(0,a.jsx)("div",{className:"flex justify-end space-x-3 pt-4",children:(0,a.jsx)("button",{onClick:()=>M(!1),className:"btn-secondary",children:"Cancel"})})]})]})})})]})})}var L=s(99376);function F(){let e=(0,L.useRouter)();return(0,a.jsx)(z,{onNavigate:t=>{e.push(t)}})}},5526:function(e,t,s){"use strict";s.d(t,{LU:function(){return c},OQ:function(){return r},k_:function(){return l},lj:function(){return d},un:function(){return i},xG:function(){return o}});var a=s(57557);let n="https://ixeqedgrusamxwsvwoho.supabase.co",r=(0,a.eI)(n,"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml4ZXFlZGdydXNhbXh3c3Z3b2hvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NDUwODcsImV4cCI6MjA2NTMyMTA4N30.tCb8nATBWRQrbhMXKT-omop5ZLNA954ObbGbQcKjxCc"),l=async function(e){var t;let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=null===(t=(await r.auth.getSession()).data.session)||void 0===t?void 0:t.access_token,l={headers:{"Content-Type":"application/json",...a&&{Authorization:"Bearer ".concat(a)}}},i=await fetch("".concat(n,"/functions/v1/").concat(e),{...l,...s,headers:{...l.headers,...s.headers}});if(!i.ok)throw Error(await i.text());return i.json()},i=e=>{if(e.startsWith("+1")&&12===e.length){let t=e.slice(2);return"(".concat(t.slice(0,3),") ").concat(t.slice(3,6),"-").concat(t.slice(6))}return e},c=e=>"".concat(Math.floor(e/60),":").concat((e%60).toString().padStart(2,"0")),o=e=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2}).format(e),d=e=>{switch(e){case"success":return"text-white bg-success-600 border border-success-500";case"failure":case"error":return"text-white bg-error-600 border border-error-500";case"no_answer":case"busy":return"text-white bg-warning-600 border border-warning-500";case"voicemail":return"text-white bg-secondary-600 border border-secondary-500";case"in_progress":return"text-white bg-primary-600 border border-primary-500";default:return"text-white bg-neutral-600 border border-neutral-500"}}},43860:function(e,t,s){"use strict";s.d(t,{q:function(){return d},w:function(){return m}});var a=s(14623),n=s(2265),r=s(5526),l=s(69064);let i={user:null,profile:null,organization:null,subscription:null,loading:!0,initialized:!1,agents:[],contacts:[],selectedAgent:null,isNavigating:!1};function c(e,t){switch(t.type){case"SET_LOADING":return{...e,loading:t.loading};case"SET_INITIALIZED":return{...e,initialized:t.initialized};case"SET_NAVIGATING":return{...e,isNavigating:t.isNavigating};case"SET_USER":return{...e,user:t.user};case"SET_PROFILE":return{...e,profile:t.profile};case"SET_ORGANIZATION":return{...e,organization:t.organization};case"SET_SUBSCRIPTION":return{...e,subscription:t.subscription};case"SET_AGENTS":return{...e,agents:t.agents};case"SET_CONTACTS":return{...e,contacts:t.contacts};case"SET_SELECTED_AGENT":return{...e,selectedAgent:t.agent};case"RESET_STATE":return{...i,initialized:!0,loading:!1};case"AUTH_SUCCESS":return{...e,user:t.payload.user,profile:t.payload.profile||null,organization:t.payload.organization||null,subscription:t.payload.subscription||null,agents:t.payload.agents||[],loading:!1,initialized:!0};default:return e}}let o=(0,n.createContext)(void 0);function d(){let e=(0,n.useContext)(o);if(void 0===e)throw Error("useApp must be used within an AppProvider");return e}function m(e){var t;let{children:s}=e,[d,m]=(0,n.useReducer)(c,i),x=async()=>{try{console.log("\uD83D\uDD04 Starting fetchUserData..."),m({type:"SET_LOADING",loading:!0});let{data:{user:e},error:t}=await r.OQ.auth.getUser();if(t||!e){console.log("\uD83D\uDC64 No user found or error:",t),m({type:"RESET_STATE"});return}console.log("✅ User found:",e.email);let{data:s,error:a}=await r.OQ.from("user_profiles").select("*").eq("id",e.id).single();if(a){console.error("❌ Error fetching profile:",a),m({type:"AUTH_SUCCESS",payload:{user:e}});return}let n=null,l=null,i=[];if(null==s?void 0:s.organization_id){let{data:e}=await r.OQ.from("organizations").select("*").eq("id",s.organization_id).single();n=e;let{data:t}=await r.OQ.from("subscriptions").select("*").eq("organization_id",s.organization_id).single();l=t;let{data:a}=await r.OQ.from("agents").select("*").eq("organization_id",s.organization_id).order("created_at",{ascending:!1});i=a||[]}m({type:"AUTH_SUCCESS",payload:{user:e,profile:s,organization:n,subscription:l,agents:i}}),console.log("✅ fetchUserData completed")}catch(e){console.error("\uD83D\uDCA5 Error in fetchUserData:",e),m({type:"SET_LOADING",loading:!1})}},u=(0,n.useMemo)(()=>({setLoading:e=>m({type:"SET_LOADING",loading:e}),setNavigating:e=>m({type:"SET_NAVIGATING",isNavigating:e}),fetchUserData:x,fetchAgents:async()=>{try{var e;if(!(null===(e=d.profile)||void 0===e?void 0:e.organization_id))return console.log("⚠️ No organization_id, cannot fetch agents"),[];let{data:t,error:s}=await r.OQ.from("agents").select("*").eq("organization_id",d.profile.organization_id).order("created_at",{ascending:!1});if(s)throw s;return m({type:"SET_AGENTS",agents:t||[]}),t||[]}catch(e){return console.error("\uD83D\uDCF4 Error fetching agents:",e),m({type:"SET_AGENTS",agents:[]}),[]}},fetchContacts:async()=>{try{var e;if(!(null===(e=d.profile)||void 0===e?void 0:e.organization_id))return;let{data:t}=await r.OQ.from("contacts").select("*").eq("organization_id",d.profile.organization_id).order("created_at",{ascending:!1});m({type:"SET_CONTACTS",contacts:t||[]})}catch(e){console.error("Error fetching contacts:",e),m({type:"SET_CONTACTS",contacts:[]})}},logout:async()=>{await r.OQ.auth.signOut(),m({type:"RESET_STATE"})}}),[null===(t=d.profile)||void 0===t?void 0:t.organization_id,m]);return(0,n.useEffect)(()=>{let e=async()=>{console.log("\uD83D\uDE80 Initializing app...");let e=new URLSearchParams(window.location.search),t="Email confirmed"===e.get("message"),s=e.get("error_description");t?(l.ZP.success("Email verified successfully! Welcome to Kai Agent."),window.history.replaceState({},document.title,window.location.pathname)):s&&(l.ZP.error("Authentication error: ".concat(s)),window.history.replaceState({},document.title,window.location.pathname));let{data:{session:a}}=await r.OQ.auth.getSession();(null==a?void 0:a.user)?await x():m({type:"RESET_STATE"}),m({type:"SET_INITIALIZED",initialized:!0})};d.initialized||e();let{data:{subscription:t}}=r.OQ.auth.onAuthStateChange(async(e,t)=>{console.log("\uD83D\uDD10 Auth state change:",{event:e,hasUser:!!(null==t?void 0:t.user)}),"SIGNED_IN"===e&&(null==t?void 0:t.user)?(m({type:"SET_NAVIGATING",isNavigating:!0}),await x(),m({type:"SET_NAVIGATING",isNavigating:!1})):"SIGNED_OUT"===e&&m({type:"RESET_STATE"})});return()=>t.unsubscribe()},[d.initialized]),(0,a.jsx)(o.Provider,{value:{state:d,dispatch:m,actions:u},children:s})}}},function(e){e.O(0,[216,744],function(){return e(e.s=16738)}),_N_E=e.O()}]);